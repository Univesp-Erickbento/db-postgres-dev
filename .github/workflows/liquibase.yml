name: CI/CD Pipeline

on:
  push:
    branches: [ master ]

jobs:
  liquibase:
    runs-on: ubuntu-latest

    env:
      DB_URL: jdbc:postgresql://${{ secrets.REMOTE_HOST }}:5432/${{ secrets.POSTGRES_DB }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
      REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
      IMAGE_NAME: torresbento/liquibase-job
      IMAGE_TAG: latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Login no Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build e push da imagem Docker com Liquibase
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG

      # üîê Configura chave SSH (usando SSH_KEY)
      - name: Configurar SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts

      # ‚úÖ Teste simples de conex√£o
      - name: Testar conex√£o SSH
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            $SSH_USERNAME@$REMOTE_HOST "echo 'SSH conectado com sucesso'"

      - name: Garantir que a rede Docker existe no servidor remoto
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            $SSH_USERNAME@$REMOTE_HOST <<EOF
          set -e
          if ! docker network ls --format '{{.Name}}' | grep -q '^tbmt-rede-docker$'; then
            docker network create tbmt-rede-docker
          fi
          EOF

      - name: Rodar Liquibase remotamente
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            $SSH_USERNAME@$REMOTE_HOST <<EOF
          set -e
          docker pull $IMAGE_NAME:$IMAGE_TAG

          docker run --rm \
            --network tbmt-rede-docker \
            -e DB_URL="$DB_URL" \
            -e DB_USERNAME="$DB_USERNAME" \
            -e DB_PASSWORD="$DB_PASSWORD" \
            $IMAGE_NAME:$IMAGE_TAG \
            --changeLogFile=changelog/db.changelog-master.xml \
            --url="$DB_URL" \
            --username="$DB_USERNAME" \
            --password="$DB_PASSWORD" \
            --driver=org.postgresql.Driver \
            update
          EOF
